<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Excel Player (Audio Only)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            background-color: #f4f4f9;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        h2 { margin-top: 0; }
        .controls { margin: 20px 0; display: flex; gap: 10px; flex-direction: column; }
        
        button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:active { background-color: #0056b3; }

        #status {
            margin-top: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        /* –°–ö–†–´–í–ê–ï–ú –ü–õ–ï–ï–† (–¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ Audio Only) */
        #player-container {
            position: absolute;
            top: -9999px;
            left: -9999px;
            width: 1px;
            height: 1px;
            visibility: hidden;
            opacity: 0;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>üéµ Excel YouTube Player</h2>
    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ .xlsx —Ñ–∞–π–ª (—Å—Å—ã–ª–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ 1-–º —Å—Ç–æ–ª–±—Ü–µ).</p>

    <div class="controls">
        <input type="file" id="fileInput" accept=".xlsx, .xls" />
        <button id="playBtn" disabled>‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ (3 —Å–µ–∫)</button>
    </div>

    <div id="status">–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...</div>
    
    <div id="player-container">
        <div id="player"></div>
    </div>
</div>

<script>
    // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
    let player; 
    let youtubeIds = [];
    let currentIndex = 0;
    let isPlaying = false;
    let stopTimer = null;

    const statusDiv = document.getElementById('status');
    const playBtn = document.getElementById('playBtn');
    const fileInput = document.getElementById('fileInput');

    // --- 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø YOUTUBE API ---
    // –ú—ã –∑–∞–≥—Ä—É–∂–∞–µ–º API –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '200',
            width: '200',
            playerVars: {
                'playsinline': 1,
                'controls': 0, // –ë–µ–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
                'disablekb': 1 // –ë–µ–∑ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange,
                'onError': onPlayerError
            }
        });
    }

    function onPlayerReady(event) {
        log("API YouTube –≥–æ—Ç–æ–≤–æ. –ñ–¥—É —Ñ–∞–π–ª.");
    }

    // --- 2. –û–ë–†–ê–ë–û–¢–ö–ê EXCEL –§–ê–ô–õ–ê ---
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        log("–ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞...");
        const reader = new FileReader();

        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JSON (–º–∞—Å—Å–∏–≤ –º–∞—Å—Å–∏–≤–æ–≤)
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å—Ç–æ–ª–±—Ü–∞ (–∏–Ω–¥–µ–∫—Å 0)
                youtubeIds = [];
                jsonData.forEach((row, index) => {
                    if (row[0]) {
                        const url = String(row[0]);
                        const id = extractVideoID(url);
                        if (id) {
                            youtubeIds.push(id);
                        } else {
                            console.warn(`–°—Ç—Ä–æ–∫–∞ ${index+1}: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞ YouTube (${url})`);
                        }
                    }
                });

                if (youtubeIds.length > 0) {
                    currentIndex = 0;
                    playBtn.disabled = false;
                    playBtn.textContent = `‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Ç—Ä–µ–∫ 1 –∏–∑ ${youtubeIds.length}`;
                    log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${youtubeIds.length} —Ç—Ä–µ–∫–æ–≤. –ù–∞–∂–º–∏—Ç–µ Play.`);
                } else {
                    log("–û—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Å—ã–ª–æ–∫ YouTube –≤ –ø–µ—Ä–≤–æ–º —Å—Ç–æ–ª–±—Ü–µ.");
                }

            } catch (err) {
                log("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è Excel: " + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // --- 3. –õ–û–ì–ò–ö–ê –í–û–°–ü–†–û–ò–ó–í–ï–î–ï–ù–ò–Ø ---
    playBtn.addEventListener('click', () => {
        if (youtubeIds.length === 0) return;

        // –ï—Å–ª–∏ –º—ã –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ —Å–ø–∏—Å–∫–∞, —Å–±—Ä–æ—Å –≤ –Ω–∞—á–∞–ª–æ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        if (currentIndex >= youtubeIds.length) {
            currentIndex = 0;
            log("–°–ø–∏—Å–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω. –ù–∞—á–∏–Ω–∞–µ–º —Å–Ω–∞—á–∞–ª–∞.");
        }

        const videoId = youtubeIds[currentIndex];
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç–∞–π–º–µ—Ä–æ–≤
        if (stopTimer) clearTimeout(stopTimer);
        
        log(`–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–µ–∫–∞ ${currentIndex + 1}/${youtubeIds.length} (ID: ${videoId})...`);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∏–¥–µ–æ. autoplay —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, —Ç–∞–∫ –∫–∞–∫ –¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–∑–≤–∞–Ω–æ –∫–ª–∏–∫–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        player.loadVideoById(videoId);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É
        playBtn.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–∫–∞ –∏–≥—Ä–∞–µ—Ç
    });

    function onPlayerStateChange(event) {
        // YT.PlayerState.PLAYING = 1
        if (event.data == YT.PlayerState.PLAYING) {
            log(`‚ñ∂ –ò–≥—Ä–∞–µ—Ç... (–¢–∞–π–º–µ—Ä 3 —Å–µ–∫ –∑–∞–ø—É—â–µ–Ω)`);
            
            // –¢–∞–π–º–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            stopTimer = setTimeout(() => {
                player.stopVideo(); // –ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
                log("‚èπ –°—Ç–æ–ø (3 —Å–µ–∫—É–Ω–¥—ã –∏—Å—Ç–µ–∫–ª–∏).");
                prepareNextTrack();
            }, 3000); // 3000 –º—Å = 3 —Å–µ–∫—É–Ω–¥—ã
        }
    }

    function prepareNextTrack() {
        currentIndex++;
        playBtn.disabled = false;
        if (currentIndex < youtubeIds.length) {
            playBtn.textContent = `‚ñ∂ –°–ª–µ–¥—É—é—â–∏–π (–¢—Ä–µ–∫ ${currentIndex + 1})`;
        } else {
            playBtn.textContent = `‚ñ∂ –ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞`;
        }
    }

    // --- 4. –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö (–ü—Ä–µ–¥–≤–∏–¥–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º) ---
    function onPlayerError(event) {
        // –ö–æ–¥—ã –æ—à–∏–±–æ–∫ API:
        // 2 ‚Äì –Ω–µ–≤–µ—Ä–Ω—ã–π ID
        // 100 ‚Äì –≤–∏–¥–µ–æ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ —Å–∫—Ä—ã—Ç–æ
        // 101, 150 ‚Äì –∑–∞–ø—Ä–µ—â–µ–Ω–æ –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ (embedding disabled)
        
        let errorMsg = "";
        switch(event.data) {
            case 2: errorMsg = "–ù–µ–≤–µ—Ä–Ω—ã–π ID –≤–∏–¥–µ–æ."; break;
            case 100: errorMsg = "–í–∏–¥–µ–æ —É–¥–∞–ª–µ–Ω–æ –∏–ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω–æ."; break;
            case 101: 
            case 150: errorMsg = "–ê–≤—Ç–æ—Ä –∑–∞–ø—Ä–µ—Ç–∏–ª –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ."; break;
            default: errorMsg = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø–ª–µ–µ—Ä–∞.";
        }

        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Ç—Ä–µ–∫–∞ ${currentIndex + 1}: ${errorMsg}. –ü—Ä–æ–ø—É—Å–∫...`);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—ã—Ç–∞–µ–º—Å—è –∏–≥—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å —Ñ–ª–æ—É
        if (stopTimer) clearTimeout(stopTimer);
        prepareNextTrack(); 
        
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∞–≤—Ç–æ-–∫–ª–∏–∫–æ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≤–µ—á–Ω–æ–≥–æ —Ü–∏–∫–ª–∞, –µ—Å–ª–∏ –≤—Å–µ –±–∏—Ç—ã–µ)
        // –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã —Ç—Ä–µ–±—É–µ–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ, –º—ã –ø—Ä–æ—Å—Ç–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É.
        // –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∞–≤—Ç–æ-—Å–∫–∏–ø, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ:
        // setTimeout(() => playBtn.click(), 1000); 
    }

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---

    // –ú–æ—â–Ω–∞—è —Ä–µ–≥—É–ª—è—Ä–∫–∞ –¥–ª—è –≤—ã—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è ID –∏–∑ –ª—é–±–æ–≥–æ —Ç–∏–ø–∞ —Å—Å—ã–ª–æ–∫ (short, full, mobile)
    function extractVideoID(url) {
        const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[7].length == 11) ? match[7] : false;
    }

    function log(msg) {
        statusDiv.textContent = msg;
        console.log(msg);
    }
</script>

</body>
</html>