<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>YouTube Audio Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { margin: 5px; padding: 10px 15px; }
    #status { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>

<h2>YouTube Audio Quiz</h2>

<input type="file" id="fileInput" accept=".xlsx,.xls">
<br><br>

<button onclick="playSegment(0)">Play (5 очков)</button>
<button onclick="playSegment(1)">Play (3 очка)</button>
<button onclick="playSegment(2)">Play (1 очко)</button>
<button onclick="nextTrack()">Next</button>

<div id="status">Файл не загружен</div>

<!-- Скрытый плеер -->
<div id="player"></div>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- YouTube API -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
let tracks = [];
let currentIndex = 0;
let player = null;
let stopTimeout = null;

// ===== Helpers =====
function parseTime(str) {
  if (!str) return null;
  const parts = str.toString().split(':');
  if (parts.length !== 2) return null;
  return parseInt(parts[0]) * 60 + parseInt(parts[1]);
}

function extractVideoId(url) {
  try {
    const u = new URL(url);
    if (u.hostname.includes('youtu.be')) return u.pathname.slice(1);
    return u.searchParams.get('v');
  } catch {
    return null;
  }
}

// ===== File loading =====
document.getElementById('fileInput').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const wb = XLSX.read(evt.target.result, { type: 'binary' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

      tracks = rows
        .map(r => {
          const videoId = extractVideoId(r[0]);
          if (!videoId) return null;

          return {
            videoId,
            title: r[1] || 'Без названия',
            segments: [
              { start: parseTime(r[2]), duration: r[3] },
              { start: parseTime(r[4]), duration: r[5] },
              { start: parseTime(r[6]), duration: r[7] }
            ]
          };
        })
        .filter(Boolean);

      currentIndex = 0;
      document.getElementById('status').textContent =
        `Загружено треков: ${tracks.length}`;

    } catch (err) {
      alert('Ошибка чтения файла');
      console.error(err);
    }
  };
  reader.readAsBinaryString(file);
});

// ===== YouTube =====
function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    height: '0',
    width: '0',
    playerVars: {
      autoplay: 0,
      controls: 0,
      disablekb: 1,
      fs: 0,
      rel: 0
    }
  });
}

// ===== Playback =====
function playSegment(typeIndex) {
  if (!tracks.length) return alert('Сначала загрузите файл');

  const track = tracks[currentIndex];
  const segment = track.segments[typeIndex];

  if (!segment || segment.start == null || !segment.duration) {
    return alert('Нет данных для этого режима');
  }

  clearTimeout(stopTimeout);

  player.loadVideoById({
    videoId: track.videoId,
    startSeconds: segment.start
  });

  document.getElementById('status').textContent =
    `▶ ${track.title} (${segment.duration} сек)`;

  stopTimeout = setTimeout(() => {
    player.stopVideo();
  }, segment.duration * 1000);
}

function nextTrack() {
  if (!tracks.length) return;
  clearTimeout(stopTimeout);
  player.stopVideo();

  currentIndex++;
  if (currentIndex >= tracks.length) currentIndex = 0;

  document.getElementById('status').textContent =
    `Следующий трек: ${tracks[currentIndex].title}`;
}
</script>

</body>
</html>
