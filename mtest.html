<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Quiz Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f4f9; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –ø–ª–µ–µ—Ä –≤–∏–∑—É–∞–ª—å–Ω–æ, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ DOM –¥–ª—è —Ä–∞–±–æ—Ç—ã API */
        #player-container { position: absolute; top: -9999px; left: -9999px; visibility: hidden; }

        .btn { padding: 10px 20px; font-size: 16px; cursor: pointer; border: none; border-radius: 5px; margin: 5px; transition: 0.3s; color: white; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .btn-upload { background-color: #3498db; }
        .btn-5 { background-color: #e74c3c; font-weight: bold; } /* –ö—Ä–∞—Å–Ω—ã–π */
        .btn-3 { background-color: #f39c12; font-weight: bold; } /* –û—Ä–∞–Ω–∂–µ–≤—ã–π */
        .btn-1 { background-color: #2ecc71; font-weight: bold; } /* –ó–µ–ª–µ–Ω—ã–π */
        .btn-next { background-color: #34495e; width: 100%; margin-top: 20px; }
        .btn-stop { background-color: #95a5a6; margin-top: 10px; }

        #status { margin-top: 15px; color: #666; font-size: 14px; }
        #current-track { font-size: 20px; margin: 20px 0; font-weight: bold; min-height: 30px; color: #333; }
        
        .controls { display: none; } /* –°–∫—Ä—ã—Ç–æ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ */
        input[type="file"] { display: none; }
        .file-label { display: inline-block; padding: 10px 20px; background: #3498db; color: white; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h2>üéµ Music Quiz Master</h2>
    
    <div id="upload-section">
        <label for="excel-file" class="file-label">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel —Ñ–∞–π–ª</label>
        <input type="file" id="excel-file" accept=".xlsx, .xls" />
    </div>

    <div id="status">–û–∂–∏–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...</div>

    <div class="controls" id="controls-area">
        <div id="current-track">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏</div>
        <div id="track-counter" style="color: #888; font-size: 12px; margin-bottom: 10px;"></div>

        <div>
            <button class="btn btn-5" onclick="playRound(5)">Play (5 –æ—á–∫–æ–≤)</button>
            <button class="btn btn-3" onclick="playRound(3)">Play (3 –æ—á–∫–∞)</button>
            <button class="btn btn-1" onclick="playRound(1)">Play (1 –æ—á–∫–æ)</button>
        </div>
        
        <button class="btn btn-stop" onclick="stopAudio()">‚èπ –°—Ç–æ–ø</button>
        <button class="btn btn-next" onclick="nextTrack()">‚û° –°–ª–µ–¥—É—é—â–∞—è –ø–µ—Å–Ω—è</button>
    </div>

    <div id="player-container">
        <div id="player"></div>
    </div>
</div>

<script>
    let playlist = [];
    let currentIndex = 0;
    let player;
    let stopTimer = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è YouTube API
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            height: '200',
            width: '200',
            playerVars: {
                'playsinline': 1,
                'controls': 0, 
                'disablekb': 1 
            },
            events: {
                'onReady': onPlayerReady,
                'onError': onPlayerError
            }
        });
    }

    function onPlayerReady(event) {
        console.log("YouTube Player –≥–æ—Ç–æ–≤");
    }

    function onPlayerError(event) {
        console.error("–û—à–∏–±–∫–∞ –ø–ª–µ–µ—Ä–∞:", event.data);
        // –ö–æ–¥—ã –æ—à–∏–±–æ–∫: 2 - –Ω–µ–≤–µ—Ä–Ω—ã–π ID, 100 - –≤–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, 101/150 - –∑–∞–ø—Ä–µ—Ç –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è
        let msg = "–û—à–∏–±–∫–∞ YouTube.";
        if(event.data === 150 || event.data === 101) msg = "–í–ª–∞–¥–µ–ª–µ—Ü –≤–∏–¥–µ–æ –∑–∞–ø—Ä–µ—Ç–∏–ª –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏–µ!";
        if(event.data === 2) msg = "–ù–µ–≤–µ—Ä–Ω—ã–π ID –≤–∏–¥–µ–æ.";
        document.getElementById('status').innerText = msg;
    }

    // 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ Excel —Ñ–∞–π–ª–∞
    document.getElementById('excel-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π –ª–∏—Å—Ç
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –º–∞—Å—Å–∏–≤–æ–≤ (header: 1 –¥–∞–µ—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ —Å—Ç—Ä–æ–∫–∞–º)
            const rawData = XLSX.utils.sheet_to_json(worksheet, {header: 1});

            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–ª–µ–π–ª–∏—Å—Ç
            playlist = rawData.filter(row => row[0] && row.length >= 2).map(row => ({
                url: row[0],
                title: row[1],
                t5_start: row[2],
                t5_dur: row[3],
                t3_start: row[4],
                t3_dur: row[5],
                t1_start: row[6],
                t1_dur: row[7]
            }));

            if (playlist.length > 0) {
                document.getElementById('status').innerText = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–µ—Å–µ–Ω: ${playlist.length}`;
                document.getElementById('controls-area').style.display = 'block';
                document.getElementById('upload-section').style.display = 'none';
                loadTrackUI(0);
            } else {
                alert("–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –∏–º–µ–µ—Ç –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç!");
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // 3. –õ–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–∞–º–∏
    function extractVideoID(url) {
        if (!url) return null;
        // –†–µ–≥—É–ª—è—Ä–∫–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è ID –∏–∑ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å—Å—ã–ª–æ–∫ YouTube
        const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[7].length == 11) ? match[7] : false;
    }

    function loadTrackUI(index) {
        if (index >= playlist.length) {
            alert("–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –≠—Ç–æ –±—ã–ª–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–µ—Å–Ω—è.");
            return;
        }
        
        const track = playlist[index];
        document.getElementById('current-track').innerText = track.title; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
        document.getElementById('track-counter').innerText = `–ü–µ—Å–Ω—è ${index + 1} –∏–∑ ${playlist.length}`;
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ (cueVideoById –∑–∞–≥—Ä—É–∂–∞–µ—Ç, –Ω–æ –Ω–µ –∏–≥—Ä–∞–µ—Ç)
        const videoId = extractVideoID(track.url);
        if (videoId && player && player.cueVideoById) {
            player.cueVideoById(videoId);
            document.getElementById('status').innerText = "–ì–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é";
        } else {
            document.getElementById('status').innerText = "–û—à–∏–±–∫–∞: –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ";
        }
    }

    function playRound(points) {
        if (!player || typeof player.loadVideoById !== 'function') {
            alert("–ü–ª–µ–µ—Ä –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –ø–æ–¥–æ–∂–¥–∏—Ç–µ —Å–µ–∫—É–Ω–¥—É.");
            return;
        }

        const track = playlist[currentIndex];
        let start, duration;

        // –í—ã–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–Ω–æ–ø–∫–∏
        if (points === 5) {
            start = parseFloat(track.t5_start);
            duration = parseFloat(track.t5_dur);
        } else if (points === 3) {
            start = parseFloat(track.t3_start);
            duration = parseFloat(track.t3_dur);
        } else {
            start = parseFloat(track.t1_start);
            duration = parseFloat(track.t1_dur);
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
        if (isNaN(start) || isNaN(duration)) {
            document.getElementById('status').innerText = "–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö (–Ω–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ Excel)";
            return;
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
        if (stopTimer) clearTimeout(stopTimer);

        document.getElementById('status').innerText = `–ò–≥—Ä–∞–µ—Ç (${points} –æ—á–∫–æ–≤): ${duration} —Å–µ–∫...`;

        // –ó–∞–ø—É—Å–∫ –≤–∏–¥–µ–æ
        const videoId = extractVideoID(track.url);
        player.loadVideoById({
            videoId: videoId,
            startSeconds: start
        });

        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        stopTimer = setTimeout(() => {
            player.pauseVideo();
            document.getElementById('status').innerText = "–í—Ä–µ–º—è –≤—ã—à–ª–æ!";
        }, duration * 1000); // —Å–µ–∫—É–Ω–¥—ã * 1000 = –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã
    }

    function stopAudio() {
        if (player && player.pauseVideo) {
            player.pauseVideo();
        }
        if (stopTimer) clearTimeout(stopTimer);
        document.getElementById('status').innerText = "–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –≤—Ä—É—á–Ω—É—é";
    }

    function nextTrack() {
        stopAudio();
        currentIndex++;
        loadTrackUI(currentIndex);
    }

</script>

</body>
</html>
