<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>YouTube Music Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; display: flex; gap: 20px; }
        .main-panel { flex: 2; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .players-panel { flex: 1; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls { margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 5px; transition: 0.3s; }
        .btn-play { background: #28a745; color: white; }
        .btn-next { background: #007bff; color: white; }
        .btn-reveal { background: #ffc107; color: black; }
        .player-row { border-bottom: 1px solid #eee; padding: 10px 0; }
        .score-btn { padding: 2px 8px; font-size: 12px; margin: 2px; background: #e9ecef; border: 1px solid #ccc; }
        #song-title { font-size: 24px; font-weight: bold; color: #dc3545; margin-top: 20px; display: none; }
        #yt-player { position: absolute; top: -1000px; left: -1000px; width: 1px; height: 1px; } /* –°–∫—Ä—ã–≤–∞–µ–º –≤–∏–¥–µ–æ */
        .status { color: #666; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="main-panel">
    <h2>üéµ –ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –í–∏–∫—Ç–æ—Ä–∏–Ω–∞</h2>
    <input type="file" id="upload" accept=".xlsx, .xls">
    <div id="status" class="status">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –Ω–∞—á–∞–ª–∞</div>

    <div class="controls">
        <button class="btn-play" onclick="playMusic(2, 3)">Play 2s (6 –æ—á–∫–æ–≤)</button>
        <button class="btn-play" onclick="playMusic(4, 5)">Play 6s (4 –æ—á–∫–∞)</button>
        <button class="btn-play" onclick="playMusic(6, 7)">Play 15s (2 –æ—á–∫–∞)</button>
    </div>

    <div class="controls">
        <button class="btn-reveal" onclick="showTitle()">–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</button>
        <button class="btn-next" onclick="nextSong()">–°–ª–µ–¥—É—é—â–∞—è –ø–µ—Å–Ω—è ‚è≠Ô∏è</button>
    </div>

    <div id="song-title">–ù–∞–∑–≤–∞–Ω–∏–µ –ø–µ—Å–Ω–∏</div>
    
    <div id="yt-player"></div>
</div>

<div class="players-panel">
    <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
    <button onclick="addPlayer()">+ –î–æ–±–∞–≤–∏—Ç—å –∏–≥—Ä–æ–∫–∞</button>
    <div id="players-list"></div>
</div>

<script>
    let songs = [];
    let currentIndex = 0;
    let player; // –û–±—ä–µ–∫—Ç YouTube –ø–ª–µ–µ—Ä–∞
    let stopTimeout;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è YouTube API
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-player', {
            height: '1',
            width: '1',
            events: { 'onReady': () => console.log("Player Ready") }
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ Excel
    document.getElementById('upload').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            songs = XLSX.utils.sheet_to_json(sheet, {header: 1});
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ - —É–¥–∞–ª–∏—Ç–µ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É songs.shift()
            songs = songs.filter(row => row[0] && row[0].includes('http'));
            currentIndex = 0;
            updateStatus();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    function updateStatus() {
        document.getElementById('status').innerText = songs.length > 0 
            ? `–ü–µ—Å–Ω—è ${currentIndex + 1} –∏–∑ ${songs.length}` 
            : "–§–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω";
        document.getElementById('song-title').style.display = 'none';
    }

    function extractVideoId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function playMusic(startCol, durationCol) {
        if (songs.length === 0) return;
        const song = songs[currentIndex];
        const videoId = extractVideoId(song[0]);
        const startTime = parseInt(song[startCol]);
        const duration = parseInt(song[durationCol]);

        if (player && player.loadVideoById) {
            clearTimeout(stopTimeout);
            player.loadVideoById({
                videoId: videoId,
                startSeconds: startTime
            });
            player.playVideo();
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            stopTimeout = setTimeout(() => {
                player.stopVideo();
            }, duration * 1000);
        }
    }

    function showTitle() {
        if (songs[currentIndex]) {
            const titleDiv = document.getElementById('song-title');
            titleDiv.innerText = songs[currentIndex][1];
            titleDiv.style.display = 'block';
        }
    }

    function nextSong() {
        if (currentIndex < songs.length - 1) {
            currentIndex++;
            updateStatus();
            if (player) player.stopVideo();
        } else {
            alert("–≠—Ç–æ –±—ã–ª–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–µ—Å–Ω—è!");
        }
    }

    // –õ–æ–≥–∏–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
    function addPlayer() {
        const name = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞:");
        if (!name) return;

        const div = document.createElement('div');
        div.className = 'player-row';
        div.innerHTML = `
            <strong>${name}</strong>: <span class="score">0</span> –æ—á–∫–æ–≤<br>
            <button class="score-btn" onclick="updateScore(this, 6)">+6</button>
            <button class="score-btn" onclick="updateScore(this, 3)">+6/2</button>
            <button class="score-btn" onclick="updateScore(this, 4)">+4</button>
            <button class="score-btn" onclick="updateScore(this, 2)">+4/2</button>
            <button class="score-btn" onclick="updateScore(this, 2)">+2</button>
            <button class="score-btn" onclick="updateScore(this, 1)">+2/2</button>
        `;
        document.getElementById('players-list').appendChild(div);
    }

    function updateScore(btn, pts) {
        const scoreSpan = btn.parentElement.querySelector('.score');
        scoreSpan.innerText = parseInt(scoreSpan.innerText) + pts;
    }
</script>

<script src="https://www.youtube.com/iframe_api"></script>

</body>
</html>

