<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>YouTube Music Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .controls, .player-section, .quiz-section { margin-bottom: 30px; padding: 15px; border-bottom: 1px solid #eee; }
        
        button { cursor: pointer; padding: 10px 15px; border: none; border-radius: 5px; font-weight: bold; margin: 5px; }
        
        .btn-gold { background: #FFD700; color: #000; }
        .btn-silver { background: #C0C0C0; color: #000; }
        .btn-bronze { background: #CD7F32; color: #fff; }
        .btn-action { background: #4CAF50; color: white; }
        .btn-nav { background: #2196F3; color: white; }
        .btn-danger { background: #f44336; color: white; }

        #timer { font-size: 24px; font-weight: bold; color: #d32f2f; margin: 10px 0; }
        #answer { font-size: 20px; color: #2e7d32; font-weight: bold; display: none; margin-top: 10px; }
        
        .player-row { display: flex; align-items: center; margin-bottom: 10px; background: #fafafa; padding: 10px; border-radius: 5px; }
        .player-row input[type="text"] { margin-right: 10px; padding: 5px; }
        .score-val { width: 50px; text-align: center; font-weight: bold; margin-right: 10px; }
        
        #yt-player { position: absolute; top: -1000px; left: -1000px; } /* Прячем видео */
    </style>
</head>
<body>

<div class="container">
    <h2>Музыкальная Викторина</h2>

    <div class="controls">
        <input type="file" id="fileInput" accept=".xlsx, .xls">
        <p id="status">Загрузите Excel файл для начала</p>
    </div>

    <div class="quiz-section" id="gameBoard" style="display:none;">
        <h3>Вопрос № <span id="currentIdx">1</span></h3>
        
        <div id="timer">Таймер: 20</div>
        
        <button class="btn-gold" onclick="playSnippet(3, 2)">Play (2 sec) Золото</button>
        <button class="btn-silver" onclick="playSnippet(4, 6)">Play (6 sec) Серебро</button>
        <button class="btn-bronze" onclick="playSnippet(5, 15)">Play (15 sec) Бронза</button>
        
        <br><br>
        <button class="btn-nav" onclick="prevTrack()">Prev</button>
        <button class="btn-nav" onclick="nextTrack()">Next</button>
        <button class="btn-action" onclick="toggleAnswer()">Показать ответ</button>
        
        <div id="answer">Ответ: <span id="answerText"></span></div>
    </div>

    <div class="player-section">
        <h3>Участники</h3>
        <div id="playersList"></div>
        <button class="btn-action" onclick="addPlayer()">+ Добавить участника</button>
    </div>
</div>

<div id="yt-player"></div>

<script>
    let tracks = [];
    let currentTrackIdx = 0;
    let player;
    let timerInterval;
    const beep = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');

    // Инициализация YouTube API
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('yt-player', {
            height: '1',
            width: '1',
            videoId: '',
            events: { 'onReady': () => console.log("Player Ready") }
        });
    }

    // Загрузка API
    const tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    // Обработка Excel
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            tracks = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            
            // Фильтруем пустые строки
            tracks = tracks.filter(row => row[0] && row[0].includes('http'));
            
            currentTrackIdx = 0;
            startGame();
        };
        reader.readAsArrayBuffer(file);
    });

    function startGame() {
        if(tracks.length === 0) return;
        document.getElementById('gameBoard').style.display = 'block';
        updateUI();
    }

    function updateUI() {
        document.getElementById('currentIdx').innerText = currentTrackIdx + 1;
        document.getElementById('answer').style.display = 'none';
        document.getElementById('answerText').innerText = tracks[currentTrackIdx][1];
        resetTimer();
        if(player) player.stopVideo();
    }

    function playSnippet(colIdx, duration) {
        const url = tracks[currentTrackIdx][0];
        const startTime = parseInt(tracks[currentTrackIdx][colIdx - 1]);
        const videoId = extractVideoId(url);

        if(!videoId) return alert("Ошибка в ссылке на YouTube");

        player.loadVideoById({
            videoId: videoId,
            startSeconds: startTime
        });

        setTimeout(() => {
            player.pauseVideo();
        }, duration * 1000);

        startTimer();
    }

    function extractVideoId(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // Таймер
    function startTimer() {
        resetTimer();
        let timeLeft = 20;
        const display = document.getElementById('timer');
        timerInterval = setInterval(() => {
            timeLeft--;
            display.innerText = `Таймер: ${timeLeft}`;
            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                beep.play();
            }
        }, 1000);
    }

    function resetTimer() {
        clearInterval(timerInterval);
        document.getElementById('timer').innerText = "Таймер: 20";
    }

    // Навигация
    function nextTrack() {
        if(currentTrackIdx < tracks.length - 1) {
            currentTrackIdx++;
            updateUI();
        }
    }

    function prevTrack() {
        if(currentTrackIdx > 0) {
            currentTrackIdx--;
            updateUI();
        }
    }

    function toggleAnswer() {
        document.getElementById('answer').style.display = 'block';
    }

    // Система подсчета очков
    function addPlayer() {
        const container = document.getElementById('playersList');
        const div = document.createElement('div');
        div.className = 'player-row';
        div.innerHTML = `
            <input type="text" placeholder="Имя игрока">
            <input type="number" class="score-val" value="0">
            <button class="btn-gold" onclick="modScore(this, 4)">+4</button>
            <button class="btn-gold" onclick="modScore(this, 8)">x2 (8)</button>
            <button class="btn-silver" onclick="modScore(this, 2)">+2</button>
            <button class="btn-silver" onclick="modScore(this, 4)">x2 (4)</button>
            <button class="btn-bronze" onclick="modScore(this, 1)">+1</button>
            <button class="btn-bronze" onclick="modScore(this, 2)">x2 (2)</button>
            <button class="btn-danger" onclick="this.parentElement.remove()">Удалить</button>
        `;
        container.appendChild(div);
    }

    function modScore(btn, val) {
        const input = btn.parentElement.querySelector('.score-val');
        input.value = parseInt(input.value) + val;
    }
</script>

</body>
</html>
