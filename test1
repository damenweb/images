<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Messages</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #messages { width: 100%; max-width: 500px; display: flex; flex-direction: column-reverse; gap: 10px; }
        .msg { background: #1e1e1e; padding: 15px; border-radius: 10px; border-left: 4px solid #3ecf8e; animation: fadeIn 0.3s ease; }
        .msg b { color: #3ecf8e; display: block; margin-bottom: 5px; }
        .msg small { color: #666; font-size: 0.8em; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Стили для формы отправки (чтобы ты мог проверить работу) */
        .input-area { margin-bottom: 30px; background: #1e1e1e; padding: 20px; border-radius: 10px; }
        input { padding: 8px; border-radius: 5px; border: none; margin-right: 5px; }
        button { padding: 8px 15px; background: #3ecf8e; border: none; border-radius: 5px; cursor: pointer; color: black; font-weight: bold; }
    </style>
</head>
<body>

    <h2>Новые сообщения</h2>

    <div class="input-area">
        <input type="text" id="author" placeholder="Имя">
        <input type="text" id="text" placeholder="Сообщение">
        <button onclick="sendMessage()">Отправить</button>
    </div>

    <div id="messages">Загрузка сообщений...</div>

    <script>
        // 1. НАСТРОЙКИ (Вставь свои данные сюда)
        const SUPABASE_URL = 'https://gatadttzyeusozvkwvai.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_cwXp1mw42C6sDXoeszY8sw_lYrAAefY';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // 2. ФУНКЦИЯ ПОЛУЧЕНИЯ СООБЩЕНИЙ
        async function fetchMessages() {
            const { data, error } = await supabase
                .from('messages')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(20);

            if (error) console.error('Ошибка:', error);
            else renderMessages(data);
        }

        // 3. ОТРИСОВКА НА ЭКРАНЕ
        function renderMessages(list) {
            const container = document.getElementById('messages');
            container.innerHTML = list.map(m => `
                <div class="msg">
                    <b>${m.author || 'Аноним'}</b>
                    <div>${m.text}</div>
                    <small>${new Date(m.created_at).toLocaleString()}</small>
                </div>
            `).join('');
        }

        // 4. РЕАЛЬНОЕ ВРЕМЯ (Слушаем изменения в базе)
        supabase
            .channel('public:messages')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                console.log('Новое сообщение!', payload);
                fetchMessages(); // Обновляем список при появлении записи
            })
            .subscribe();

        // 5. ОТПРАВКА (Для теста)
        async function sendMessage() {
            const author = document.getElementById('author').value;
            const text = document.getElementById('text').value;
            
            await supabase.from('messages').insert([{ author, text }]);
            document.getElementById('text').value = ''; // Очистить поле
        }

        // Загрузить при старте
        fetchMessages();
    </script>
</body>
</html>
