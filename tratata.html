<script>
    const S_URL = 'https://gatadttzyeusozvkwvai.supabase.co';
    const S_KEY = 'sb_publishable_cwXp1mw42C6sDXoeszY8sw_lYrAAefY';
    const supabaseClient = supabase.createClient(S_URL, S_KEY);

    let mySavedName = localStorage.getItem('quiz_player_name');
    let myLogin = "";
    let localTimerId;
    let currentLvlPrefix = ""; 
    let hasSentAnswer = false; // НОВАЯ ПЕРЕМЕННАЯ: флаг отправки

    window.onload = async () => {
        const { data: { user } } = await supabaseClient.auth.getUser();
        if (user) handleUserSession(user);
    };

    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) document.getElementById('auth-status').innerText = "Ошибка: " + error.message;
        else handleUserSession(data.user);
    }

    function handleUserSession(user) {
        myLogin = user.email.split('@')[0];
        document.getElementById('auth-screen').classList.add('hidden');
        if (!mySavedName) {
            document.getElementById('name-screen').classList.remove('hidden');
        } else {
            startGame();
        }
    }

    function saveName() {
        const name = document.getElementById('pName').value.trim();
        if (!name) return alert("Введите имя!");
        mySavedName = name;
        localStorage.setItem('quiz_player_name', name);
        document.getElementById('name-screen').classList.add('hidden');
        startGame();
    }

    function editName() {
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('name-screen').classList.remove('hidden');
        document.getElementById('pName').value = mySavedName;
    }

    function startGame() {
        document.getElementById('game-screen').classList.remove('hidden');
        document.getElementById('display-name').innerText = mySavedName;
    }

    // ОТПРАВКА ОТВЕТА
    async function send() {
        if (hasSentAnswer) return; // Страховка

        const input = document.getElementById('pAns');
        const btn = document.getElementById('sendBtn');
        const text = input.value.trim();
        if(!text) return;

        hasSentAnswer = true; // Блокируем до конца раунда
        btn.disabled = true; 
        document.getElementById('status').innerText = "Ответ принят! Жди следующий трек.";
        
        const fullName = `${currentLvlPrefix}${mySavedName} (${myLogin})`;
        
        await supabaseClient.from('quiz_chat').insert([
            { player_name: fullName, message: text }
        ]);
    }

    const channel = supabaseClient.channel('quiz_chat');

    // 1. Сброс раунда (когда админ переключает трек)
    channel.on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'quiz_chat' }, () => {
        hasSentAnswer = false; // ТЕПЕРЬ МОЖНО СНОВА ОТВЕЧАТЬ
        document.getElementById('sendBtn').disabled = true;
        document.getElementById('pAns').value = "";
        document.getElementById('status').innerText = "Новый трек! Жди кнопку.";
        document.getElementById('lvl-badge').innerText = "ОЖИДАНИЕ ТРЕКА";
        currentLvlPrefix = "";
        clearInterval(localTimerId);
        document.getElementById('player-timer').innerText = "00";
        document.getElementById('player-timer').classList.remove('timer-low');
    });

    // 2. Получение сигнала таймера
    channel.on('broadcast', { event: 'start_timer' }, (payload) => {
        const sec = payload.payload.sec;
        currentLvlPrefix = payload.payload.lvl || ""; 

        if (sec > 0) {
            // Разблокируем кнопку только если ответ еще не был дан в этом раунде
            if (!hasSentAnswer) {
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('status').innerText = "Кнопка активна! Пиши!";
            } else {
                document.getElementById('status').innerText = "Ты уже ответил в этом раунде.";
            }
            
            document.getElementById('lvl-badge').innerText = currentLvlPrefix ? "АКТИВЕН " + currentLvlPrefix : "ПОЛНАЯ ВЕРСИЯ";
            startLocalTimer(sec);
        } else {
            stopGameAction();
        }
    }).subscribe();

    function stopGameAction() {
        clearInterval(localTimerId);
        document.getElementById('sendBtn').disabled = true;
        document.getElementById('player-timer').innerText = "00";
        if (!hasSentAnswer) {
            document.getElementById('status').innerText = "Время вышло!";
        }
    }

    function startLocalTimer(seconds) {
        clearInterval(localTimerId);
        let left = seconds;
        const timerEl = document.getElementById('player-timer');
        timerEl.classList.remove('timer-low');
        timerEl.innerText = left < 10 ? '0' + left : left;

        localTimerId = setInterval(() => {
            left--;
            if (left <= 0) {
                stopGameAction();
            } else {
                timerEl.innerText = left < 10 ? '0' + left : left;
                if (left <= 5) timerEl.classList.add('timer-low');
            }
        }, 1000);
    }
</script>
